<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reachout</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- intl-tel-input styles -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@19.5.6/build/css/intlTelInput.css" />

  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <!-- Google Maps API -->
  <script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_key }}&libraries=places&callback=initMap" async defer></script>
</head>
<body onload="initMap()">

  <div class="container py-5">
    <h1 class="text-center mb-4 fw-bold">Report an Incident</h1>

    <div class="card p-4">
      <form method="POST" enctype="multipart/form-data" class="row g-3">

        <!-- Reporter details -->
        <div class="col-md-6">
          <label for="reporter_name" class="form-label">Your Name</label>
          <input type="text" class="form-control" id="reporter_name" name="reporter_name" placeholder="Full name" required>
        </div>
        <div class="col-md-6">
          <label for="reporter_phone" class="form-label">Phone Number</label>
          <input type="tel" class="form-control" id="reporter_phone" name="reporter_phone_display" placeholder="Enter phone number" required>
          <input type="hidden" id="reporter_phone_e164" name="reporter_phone">
          <input type="hidden" id="reporter_country_code" name="country_code">
        <div style="display: flex; align-items: center; gap: 0.5rem;">
          <button type="button" id="send-otp" style="background: #ffc107; color: #222; border: none; border-radius: 7px; padding: 0.6rem 1.1rem; font-weight: 600; font-size: 1rem; cursor: pointer;">Send OTP</button>
            <input type="text" id="otp-input" placeholder="Enter OTP" style="width:120px; margin-left:8px;" maxlength="6">
            <button type="button" id="verify-otp" style="background: #28a745; color: #fff; border: none; border-radius: 7px; padding: 0.6rem 1.1rem; font-weight: 600; font-size: 1rem; cursor: pointer; margin-left:4px;">Verify OTP</button>
            <span id="otp-status" style="margin-left:8px;font-weight:600;"></span>
        </div>
      
        </div>

        <div class="col-12">
          <label for="type" class="form-label">Incident Type</label>
          <input type="text" class="form-control" name="type" placeholder="e.g., Fire, Accident, Flood" required>
        </div>

        <div class="col-12">
          <label for="attachments" class="form-label">Attachments</label>
          <input type="file" class="form-control" name="attachments" id="attachments" accept=".png,.jpg,.jpeg,.mp4" multiple required>
          <div class="form-text">Up to 3 files (Images or Videos).</div>
        </div>

        <div class="col-12">
          <label for="address" class="form-label">Location</label>
          <div class="input-group">
            <input type="text" class="form-control" name="address" placeholder="Enter an address" required>
            <button type="button" id="btnUseGps" class="btn btn-warning">Fetch Location</button>
          </div>
          <div class="form-text">Tap "Fetch Location" to autofill your location.</div>
        </div>

        <div class="col-12">
          <label class="form-label">Click on the Map to Tag Location</label>
          <div id="map"></div>
          <div class="note mt-1">Tip: Zoom in and click the exact location.</div>
        </div>

        <input type="hidden" id="lat" name="lat">
        <input type="hidden" id="lng" name="lng">

        <div class="col-12 text-center">
          <button type="submit" class="btn btn-success btn-submit">Submit</button>
        </div>
      </form>
    </div>

    <div class="d-flex justify-content-center gap-3 mt-4">
      <form action="/all-reports" method="get">
        <button type="submit" class="btn btn-warning">All Reported Incidents</button>
      </form>
      <form action="/admin" method="get">
        <button type="submit" class="btn btn-primary">Go to Admin Page</button>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@19.5.6/build/js/intlTelInput.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@19.5.6/build/js/utils.js"></script>

  <script>
    let map, marker, autocomplete;
    function initMap() {
      const defaultLocation = { lat: 23.0225, lng: 72.5714 };
      map = new google.maps.Map(document.getElementById("map"), {
        center: defaultLocation,
        zoom: 12,
      });
      const geocoder = new google.maps.Geocoder();
      const placesService = new google.maps.places.PlacesService(map);
      map.addListener("click", (e) => {
        // If clicking on a POI, fetch exact place details
        if (e.placeId) {
          e.stop(); // Prevent default info window
          placesService.getDetails({
            placeId: e.placeId,
            fields: ["name", "formatted_address", "geometry"],
          }, (place, status) => {
            if (status === google.maps.places.PlacesServiceStatus.OK && place) {
              const pos = (place.geometry && place.geometry.location) ? place.geometry.location : e.latLng;
              if (marker) marker.setMap(null);
              marker = new google.maps.Marker({ position: pos, map: map });
              document.getElementById("lat").value = pos.lat().toFixed(7);
              document.getElementById("lng").value = pos.lng().toFixed(7);
              const name = place.name ? `${place.name}, ` : "";
              document.querySelector('input[name="address"]').value = `${name}${place.formatted_address || ''}`.replace(/,\s*$/, "");
            } else {
              // Fallback to reverse geocoding if details failed
              if (marker) marker.setMap(null);
              marker = new google.maps.Marker({ position: e.latLng, map: map });
              document.getElementById("lat").value = e.latLng.lat().toFixed(7);
              document.getElementById("lng").value = e.latLng.lng().toFixed(7);
              geocoder.geocode({ location: e.latLng }, (results, s) => {
                if (s === "OK" && results[0]) {
                  document.querySelector('input[name="address"]').value = results[0].formatted_address;
                }
              });
            }
          });
          return;
        }

        // Non-POI click: place a marker and reverse geocode
    if (marker) marker.setMap(null);
    marker = new google.maps.Marker({ position: e.latLng, map: map });
    document.getElementById("lat").value = e.latLng.lat().toFixed(7);
    document.getElementById("lng").value = e.latLng.lng().toFixed(7);
        geocoder.geocode({ location: e.latLng }, (results, status) => {
          if (status === "OK" && results[0]) {
            document.querySelector('input[name="address"]').value = results[0].formatted_address;
          }
        });
      });

      const input = document.querySelector('input[name="address"]');
      autocomplete = new google.maps.places.Autocomplete(input);
      autocomplete.addListener('place_changed', () => {
        const place = autocomplete.getPlace();
        if (place.geometry && place.geometry.location) {
          map.setCenter(place.geometry.location);
          map.setZoom(16);
          if (marker) marker.setMap(null);
          marker = new google.maps.Marker({ position: place.geometry.location, map: map });
          document.getElementById("lat").value = place.geometry.location.lat().toFixed(7);
          document.getElementById("lng").value = place.geometry.location.lng().toFixed(7);
        }
      });
    }

    document.getElementById('attachments').addEventListener('change', function() {
      if (this.files.length > 3) {
        alert('You can only upload up to 3 files.');
        this.value = '';
      }
      for (let file of this.files) {
        const ext = file.name.split('.').pop().toLowerCase();
        if (!['png', 'jpg', 'jpeg', 'mp4'].includes(ext)) {
          alert('Only png, jpg, jpeg, and mp4 files are allowed.');
          this.value = '';
          break;
        }
      }
    });

    // Initialize international telephone input
    const phoneInput = document.getElementById('reporter_phone');
    const iti = window.intlTelInput(phoneInput, {
      initialCountry: 'auto',
      utilsScript: 'https://cdn.jsdelivr.net/npm/intl-tel-input@19.5.6/build/js/utils.js',
      nationalMode: false,
      separateDialCode: true,
      geoIpLookup: async (callback) => {
        try {
          const res = await fetch('https://ipapi.co/json');
          const data = await res.json();
          callback(data && data.country_code ? data.country_code : 'IN');
        } catch { callback('IN'); }
      },
    });

    // On form submit, place E.164 phone and dial code into hidden inputs
    document.querySelector('form').addEventListener('submit', function(e) {
      const isValid = iti.isValidNumber();
      if (!isValid) {
        e.preventDefault();
        alert('Please enter a valid phone number.');
        return false;
      }
      const e164 = iti.getNumber();
      const dialCode = '+' + (iti.getSelectedCountryData()?.dialCode || '');
      document.getElementById('reporter_phone_e164').value = e164;
      document.getElementById('reporter_country_code').value = dialCode;
    });

    // Use device GPS to fetch location
    document.getElementById('btnUseGps').addEventListener('click', async () => {
      const btn = document.getElementById('btnUseGps');
      const prev = btn.textContent;
      btn.disabled = true; btn.textContent = 'Fetchingâ€¦';
      try {
        if (!('geolocation' in navigator)) throw new Error('Geolocation not supported on this device');

        try {
          if (navigator.permissions && navigator.permissions.query) {
            const p = await navigator.permissions.query({ name: 'geolocation' });
            if (p.state === 'denied') {
              throw new Error('Permission denied. Please enable Location for this site in your browser settings and try again.');
            }
          }
        } catch (_) { /* ignore if Permissions API not supported */ }

        const pos = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0,
          });
        });
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        const res = await fetch('/fetch-location', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ lat, lng })
        });
        const data = await res.json();
        if (!res.ok || data.error) throw new Error(data.error || 'Reverse geocoding failed');
        document.querySelector('input[name="address"]').value = data.address || '';
        document.getElementById('lat').value = Number(data.lat).toFixed(7);
        document.getElementById('lng').value = Number(data.lng).toFixed(7);
        const center = { lat: Number(data.lat), lng: Number(data.lng) };
        if (map) {
          map.setCenter(center); map.setZoom(16);
          if (marker) marker.setMap(null);
          marker = new google.maps.Marker({ position: center, map: map });
        }
      } catch (e) {
        let msg = 'Could not get GPS location. ' + (e && e.message ? e.message : '');
        // If user denied explicitly
        if (e && typeof e.code === 'number' && e.code === 1) {
          msg += '\n\nIt looks like location was blocked. Please:' +
                 '\n- Open your browser site settings for this page' +
                 '\n- Allow Location (set to "Allow").' +
                 '\n- Then reload and tap Fetch Location again.';
        }
        if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
          msg += '\n\nHint: Most mobile browsers require HTTPS for GPS. Use your ngrok https:// URL.';
        }
        alert(msg);
      } finally {
        btn.disabled = false; btn.textContent = prev;
      }
    });
  </script>
  <script src="/static/theme.js"></script>
  </body>
  <script>
    // OTP logic
    document.getElementById('send-otp').addEventListener('click', async function() {
      const e164 = window.intlTelInputGlobals.getInstance(document.getElementById('reporter_phone')).getNumber();
      if (!e164 || e164.length < 8) {
        document.getElementById('otp-status').textContent = 'Enter valid phone';
        document.getElementById('otp-status').style.color = 'red';
        return;
      }
      document.getElementById('otp-status').textContent = 'Sending OTP...';
      document.getElementById('otp-status').style.color = '#222';
      try {
        const res = await fetch('/send-otp', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone: e164 })
        });
        const data = await res.json();
        if (data.success) {
          document.getElementById('otp-status').textContent = 'OTP sent!';
          document.getElementById('otp-status').style.color = 'green';
        } else {
          document.getElementById('otp-status').textContent = 'Failed to send OTP';
          document.getElementById('otp-status').style.color = 'red';
        }
      } catch (e) {
        document.getElementById('otp-status').textContent = 'Error sending OTP';
        document.getElementById('otp-status').style.color = 'red';
      }
    });

    document.getElementById('verify-otp').addEventListener('click', async function() {
      const e164 = window.intlTelInputGlobals.getInstance(document.getElementById('reporter_phone')).getNumber();
      const otp = document.getElementById('otp-input').value.trim();
      if (!e164 || !otp) {
        document.getElementById('otp-status').textContent = 'Enter phone and OTP';
        document.getElementById('otp-status').style.color = 'red';
        return;
      }
      document.getElementById('otp-status').textContent = 'Verifying...';
      document.getElementById('otp-status').style.color = '#222';
      try {
        const res = await fetch('/verify-otp', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone: e164, otp })
        });
        const data = await res.json();
        if (data.success) {
          document.getElementById('otp-status').textContent = 'Verified!';
          document.getElementById('otp-status').style.color = 'green';
        } else {
          document.getElementById('otp-status').textContent = 'Invalid OTP';
          document.getElementById('otp-status').style.color = 'red';
        }
      } catch (e) {
        document.getElementById('otp-status').textContent = 'Error verifying OTP';
        document.getElementById('otp-status').style.color = 'red';
      }
    });
  </script>
  </html>
</body>
</html>
